{% load static %}
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="{% static 'CSS/index.css' %}">
  <link rel="stylesheet" href="{% static 'CSS/navbar.css' %}">
  <link rel="icon" type="image/png" href="{% static 'Img/logo_san_bernardo2.png' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
  <script src="https://kit.fontawesome.com/6a284d15f6.js" crossorigin="anonymous"></script>
  <title>Ruta en San Bernardo</title>
</head>

<body>

  <nav id="navbar" class="navbar">

    <!-- Bot√≥n del men√∫ desplegable -->
    <div class="dropdown">
      <i id="boton-opciones" role="button" class="fa-solid fa-bars dropdown-toggle" onclick="toggleDropdown()">
        <div class="dropdown-menu" id="dropdownMenu">

          <a href="{% url 'index' %}" class="dropdown-item">
            <i class="fa-solid fa-map"></i> Mapa
          </a>
          <a href="" class="dropdown-item">
            <i class="fa-solid fa-list"></i> Historial de Alertas
          </a>
          <a href="" class="dropdown-item">
            <i class="fa-solid fa-chart-pie"></i> Graficos
          </a>

        </div>
      </i>
    </div>

    <h2 class="titulo-pagina">Seguridad Ciudadana "San Bernardo"</h2>

    <!-- Bot√≥n del men√∫ Usuario -->
    <div class="dropdown2">
      <i id="boton-usuario" role="button" class="fa-solid fa-user dropdown-toggle2" onclick="toggleDropdown2()">
        <div class="dropdown-menu2" id="dropdownUsuario">

          <!-- ‚úÖ Mostrar informaci√≥n del usuario si est√° logueado -->
          {% if user.is_authenticated %}
          <div class="user-info">
            <strong>{{ user.nombre_usuario }} {{ user.apellido_pat_usuario }}</strong>
            <small>{{ user.id_rol.nombre_rol }}</small>
          </div>
          <div class="dropdown-divider"></div>
          {% endif %}

          <!-- ‚úÖ Enlace de Cerrar Sesi√≥n -->
          <a href="{% url 'logout' %}" class="dropdown-item2 logout-btn">
            <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesi√≥n
          </a>

          <!-- Mantener otros enlaces si los necesitas -->
          <a href="{% url 'Admin' %}" class="dropdown-item2">
            <i class="fa-solid fa-list"></i> Historial de Alertas
          </a>

        </div>
      </i>
    </div>

  </nav>

  <div class="content">

    <!-- Bloque con el mapa de san bernardo -->
    <div class="mapa">
      <div id="map" class="map"></div>
    </div>

    <!-- NUEVO: Panel lateral con las 3 funcionalidades -->
    <div class="panel-lateral">

      <!-- 1. Bot√≥n para agregar denuncias -->
      <button class="btn-agregar-denuncia" onclick="abrirModalDenuncia()">
        <i class="fa-solid fa-plus"></i>
        Agregar Denuncia
      </button>

      <!-- 2. Lista de denuncias del d√≠a -->
      <div class="lista-denuncias">
        <h3><i class="fa-solid fa-list"></i> Denuncias de Hoy</h3>
        <div class="lista-contenido" id="lista-denuncias-hoy">
          <!-- Las denuncias se cargar√°n aqu√≠ din√°micamente -->
          <div class="cargando">Cargando denuncias...</div>
        </div>
      </div>

      <!-- 3. Lista de asignaciones de veh√≠culos -->
      <div class="lista-vehiculos">
        <h3><i class="fa-solid fa-car"></i> Veh√≠culos Asignados</h3>
        <div class="lista-contenido" id="lista-vehiculos-asignados">
          <!-- Los veh√≠culos asignados se cargar√°n aqu√≠ din√°micamente -->
          <div class="cargando">Cargando veh√≠culos...</div>
        </div>
      </div>

    </div>

  </div>

  <!-- Modal para agregar denuncias -->
  <div id="modalDenuncia" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Agregar Nueva Denuncia</h2>
        <span class="close" onclick="cerrarModalDenuncia()">&times;</span>
      </div>
      <form id="formDenuncia" class="modal-form">

        <!-- Informaci√≥n del Ciudadano -->
        <div class="seccion-formulario">
          <h3><i class="fa-solid fa-user"></i> Informaci√≥n del Ciudadano</h3>

          <div class="form-group">
            <label for="nombre_ciudadano">Nombre del Ciudadano *</label>
            <input type="text" id="nombre_ciudadano" name="nombre_ciudadano" required>
          </div>

          <div class="form-group">
            <label for="telefono_ciudadano">Tel√©fono del Ciudadano *</label>
            <input type="tel" id="telefono_ciudadano" name="telefono_ciudadano" required>
          </div>
        </div>

        <!-- Ubicaci√≥n de la Denuncia -->
        <div class="seccion-formulario">
          <h3><i class="fa-solid fa-location-dot"></i> Ubicaci√≥n</h3>

          <div class="form-group">
            <label>Seleccionar ubicaci√≥n:</label>
            <div class="selector-metodo">
              <button type="button" class="btn-metodo active" data-metodo="manual"
                onclick="cambiarMetodoUbicacion('manual')">
                <i class="fa-solid fa-keyboard"></i> Ingresar Manualmente
              </button>
              <button type="button" class="btn-metodo" data-metodo="mapa" onclick="cambiarMetodoUbicacion('mapa')">
                <i class="fa-solid fa-map-marker-alt"></i> Seleccionar en Mapa
              </button>
            </div>
          </div>

          <!-- M√©todo Manual -->
          <div id="metodo-manual" class="metodo-ubicacion">
            <div class="form-group">
              <label for="direccion">Direcci√≥n Principal *</label>
              <input type="text" id="direccion" name="direccion" placeholder="Ej: Av. Bernardo O'Higgins 123" required>
            </div>

            <div class="form-group">
              <label for="direccion_secundaria">Direcci√≥n Secundaria (opcional)</label>
              <input type="text" id="direccion_secundaria" name="direccion_secundaria"
                placeholder="Ej: Entre calles San Juan y Los Alerces">
            </div>
          </div>

          <!-- M√©todo Mapa -->
          <div id="metodo-mapa" class="metodo-ubicacion" style="display: none;">
            <div class="instrucciones-mapa">
              <p><i class="fa-solid fa-info-circle"></i> Haz clic en el mapa para seleccionar la ubicaci√≥n</p>
            </div>
            <div class="mini-mapa-contenedor">
              <div id="mini-mapa" class="mini-mapa"></div>
            </div>
            <div class="form-group">
              <label>Direcci√≥n seleccionada:</label>
              <div id="direccion-seleccionada" class="direccion-seleccionada">
                <span class="texto-direccion vacia">No se ha seleccionado ubicaci√≥n</span>
                <button type="button" class="btn-limpiar-ubicacion" onclick="limpiarUbicacionMapa()">
                  <i class="fa-solid fa-times"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Cuadrante (se llena autom√°ticamente) -->
          <div class="form-group">
            <label for="cuadrante">Cuadrante *</label>
            <select id="cuadrante" name="cuadrante" required>
              <option value="">Seleccione cuadrante</option>
              <option value="80">Cuadrante 80 - Centro</option>
              <option value="81">Cuadrante 81 - Nororiente</option>
              <option value="82">Cuadrante 82 - Norponiente</option>
              <option value="83">Cuadrante 83 - Suroriente</option>
              <option value="84">Cuadrante 84 - Surponiente</option>
              <option value="85">Cuadrante 85 - Extremo Norte</option>
              <option value="86">Cuadrante 86 - Extremo Sur</option>
            </select>
          </div>
        </div>

        <!-- Detalles de la Denuncia -->
        <div class="seccion-formulario">
          <h3><i class="fa-solid fa-circle-info"></i> Detalles de la Denuncia</h3>

          <div class="form-group">
            <label for="requerimiento">Tipo de Requerimiento *</label>
            <select id="requerimiento" name="requerimiento" required>
              <option value="">Seleccione un requerimiento</option>
            </select>
          </div>

          <div class="form-group">
            <label for="detalle">Detalle de la Denuncia *</label>
            <textarea id="detalle" name="detalle" rows="4" placeholder="Describa los detalles de la denuncia..."
              required></textarea>
          </div>

          <div class="form-group">
            <label for="movil">M√≥vil a Asignar (opcional)</label>
            <select id="movil" name="movil">
              <option value="">Seleccione un m√≥vil (opcional)</option>
              <!-- Los m√≥viles se cargar√°n din√°micamente -->
            </select>
          </div>

          <div class="form-group">
            <label for="visibilidad_camaras">
              <input type="checkbox" id="visibilidad_camaras" name="visibilidad_camaras">
              Visibilidad en C√°maras
            </label>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" onclick="cerrarModalDenuncia()" class="btn-cancelar">Cancelar</button>
          <button type="submit" class="btn-guardar">Guardar Denuncia</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // ‚úÖ MOSTRAR BIENVENIDA EN INDEX (no en login)
      {% if mostrar_bienvenida and usuario_nombre %}
      Swal.fire({
        icon: 'success',
        title: `¬°Bienvenido/a {{ usuario_rol }}! üéâ`,
        text: '{{ usuario_nombre|escapejs }}',
        confirmButtonText: 'Comenzar',
        confirmButtonColor: '#28a745',
        background: '#1e1e1e',
        color: 'white',
        timer: 4000,
        timerProgressBar: true
      });
      {% endif %}

      // Cargar datos iniciales
      cargarDenunciasDelDia();
      cargarVehiculosAsignados();
      cargarRequerimientos();
      inicializarMapa();
    });
  </script>

  <!-- Ejecuci√≥n de Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="{% static 'JavaScript/redirecciones.js' %}"></script>
  <script src="{% static 'JavaScript/index-funcionalidades.js' %}"></script>
</body>

</html>